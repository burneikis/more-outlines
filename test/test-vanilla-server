#!/bin/bash

# More Outlines Test - Vanilla Server
# Sets up and runs a vanilla Minecraft server for testing purposes

set -e

SERVER_DIR="vanilla-server"
MINECRAFT_VERSION="1.21.8"
FABRIC_VERSION="0.16.14"
FABRIC_API_VERSION="0.131.0+1.21.8"
MEMORY="2G"

echo "ğŸ® Setting up vanilla server for testing..."

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
cd "$SCRIPT_DIR"

# Create server directory
mkdir -p "$SERVER_DIR"
cd "$SERVER_DIR"

# Create basic server structure
mkdir -p mods config logs

# Download Fabric server installer if not present
if [ ! -f "fabric-server-installer.jar" ]; then
    echo "ğŸ“¥ Downloading Fabric server installer..."
    curl -L -o fabric-server-installer.jar "https://maven.fabricmc.net/net/fabricmc/fabric-installer/1.0.1/fabric-installer-1.0.1.jar"
fi

# Install Fabric server if server jar doesn't exist
if [ ! -f "fabric-server-launch.jar" ]; then
    echo "ğŸ”§ Installing Fabric server..."
    java -jar fabric-server-installer.jar server -mcversion "$MINECRAFT_VERSION" -loader "$FABRIC_VERSION" -downloadMinecraft
fi

# Download Fabric API if not present
if [ ! -f "mods/fabric-api-$FABRIC_API_VERSION.jar" ]; then
    echo "ğŸ“¥ Downloading Fabric API..."
    curl -L -o "mods/fabric-api-$FABRIC_API_VERSION.jar" "https://github.com/FabricMC/fabric/releases/download/$FABRIC_API_VERSION/fabric-api-$FABRIC_API_VERSION.jar"
fi

# Create server.properties
cat > server.properties << EOF
enable-jmx-monitoring=false
rcon.port=25575
level-seed=
gamemode=creative
enable-command-block=true
enable-query=false
generator-settings={}
enforce-secure-profile=true
level-name=world
motd=More Outlines Vanilla Test Server
query.port=25565
pvp=true
generate-structures=true
max-chained-neighbor-updates=1000000
difficulty=peaceful
network-compression-threshold=256
max-tick-time=60000
require-resource-pack=false
use-native-transport=true
max-players=20
online-mode=false
enable-status=true
allow-flight=true
initial-disabled-packs=
broadcast-rcon-to-ops=true
view-distance=10
server-ip=
resource-pack-prompt=
allow-nether=true
server-port=25565
enable-rcon=false
sync-chunk-writes=true
op-permission-level=4
prevent-proxy-connections=false
hide-online-players=false
resource-pack=
entity-broadcast-range-percentage=100
simulation-distance=10
rcon.password=
player-idle-timeout=0
debug=false
force-gamemode=false
rate-limit=0
hardcore=false
white-list=false
broadcast-console-to-ops=true
spawn-npcs=true
spawn-animals=true
log-ips=true
function-permission-level=2
initial-enabled-packs=vanilla
level-type=minecraft\:normal
text-filtering-config=
spawn-monsters=true
enforce-whitelist=false
spawn-protection=0
resource-pack-sha1=
max-world-size=29999984
EOF

echo "âœ… Vanilla server setup complete!"
echo ""
echo "ğŸ“‹ IMPORTANT: You must accept the Minecraft EULA to continue"
echo "ğŸ”— Please read the EULA at: https://aka.ms/MinecraftEULA"
echo "ğŸ“ If you agree, type 'yes' to accept:"
read -p "> " eula_response

if [[ "$eula_response" != "yes" ]]; then
    echo "âŒ EULA not accepted. Exiting."
    exit 1
fi

echo "eula=true" > eula.txt
echo "âœ… EULA accepted!"
echo "ğŸš€ Starting vanilla server..."
echo "ğŸ® Server will be available on localhost:25565"
echo "ğŸ“ Check logs in $SERVER_DIR/logs/"
echo "ğŸ›‘ Press Ctrl+C to stop the server"
echo ""
echo "ğŸ”— In another terminal, run: ./gradlew runClient"
echo "ğŸ¯ Then join localhost:25565 in the client"
echo ""

java -Xmx$MEMORY -Xms$MEMORY -jar fabric-server-launch.jar nogui